<!DOCTYPE html>
<html>
<head>
  <!-- Thẻ meta để đảm bảo trang web hiển thị đúng trên mọi thiết bị và mọi cửa sổ trình duyệt -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Tiêu đề trang web hiển thị trên thanh tab của trình duyệt -->
  <title>Cropper và Upload Ảnh</title>
  
  <!-- Liên kết đến Bootstrap CSS để sử dụng framework cho trang web -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" 
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" 
    crossorigin="anonymous">
  
  <!-- Liên kết đến Cropper.js CSS để sử dụng thư viện cho việc crop ảnh -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
  
  <style>
  body {
    background-color: #BFD8D2; /* Màu xanh pastel */
    text-align: center;  
    font-family: 'Arial', sans-serif; /* Phông chữ mặc định */
    padding-top: 50px; /* Đẩy nội dung xuống một chút để tránh navbar  */
  }

  .button { /* Áp dụng style chung cho các nút */
    background-color: #FFD700; /* Màu vàng */
    color: white; /* Chữ màu trắng */
    padding: 15px 32px; /* Đệm xung quanh nội dung bên trong nút */
    text-align: center; /* Căn giữa nội dung nút */
    text-decoration: none; /* Không gạch chân cho liên kết */
    display: inline-block; /* Cho phép xác định kích thước nút */
    font-size: 16px; /* Cỡ chữ nút */
    margin: 4px 2px; /* Khoảng cách giữa các nút */
    cursor: pointer; /* Con trỏ chuột khi di chuyển qua nút */
    border: none; /* Không viền */
    border-radius: 10px; /* Bo góc nút */
    box-shadow: 0 4px #999; /* Tạo bóng cho nút */
    transition: all 0.2s ease-in-out; /* Thời gian chuyển tiếp khi thay đổi style */
  }
    .upload-button { /* Áp dụng style chung cho các nút */
    background-color: #FFD700; /* Màu vàng */
    color: white; /* Chữ màu trắng */
    padding: 15px 32px; /* Đệm xung quanh nội dung bên trong nút */
    text-align: center; /* Căn giữa nội dung nút */
    text-decoration: none; /* Không gạch chân cho liên kết */
    display: inline-block; /* Cho phép xác định kích thước nút */
    font-size: 16px; /* Cỡ chữ nút */
    margin: 4px 2px; /* Khoảng cách giữa các nút */
    cursor: pointer; /* Con trỏ chuột khi di chuyển qua nút */
    border: none; /* Không viền */
    border-radius: 10px; /* Bo góc nút */
    box-shadow: 0 4px #999; /* Tạo bóng cho nút */
    transition: all 0.2s ease-in-out; /* Thời gian chuyển tiếp khi thay đổi style */
  }
    , .upload-submit { /* Áp dụng style chung cho các nút */
    background-color: #FFD700; /* Màu vàng */
    color: white; /* Chữ màu trắng */
    padding: 15px 32px; /* Đệm xung quanh nội dung bên trong nút */
    text-align: center; /* Căn giữa nội dung nút */
    text-decoration: none; /* Không gạch chân cho liên kết */
    display: inline-block; /* Cho phép xác định kích thước nút */
    font-size: 16px; /* Cỡ chữ nút */
    margin: 4px 2px; /* Khoảng cách giữa các nút */
    cursor: pointer; /* Con trỏ chuột khi di chuyển qua nút */
    border: none; /* Không viền */
    border-radius: 10px; /* Bo góc nút */
    box-shadow: 0 4px #999; /* Tạo bóng cho nút */
    transition: all 0.2s ease-in-out; /* Thời gian chuyển tiếp khi thay đổi style */


  .button:hover, .upload-button:hover, .upload-submit:hover { /* Style khi hover vào nút */
    background-color: #ffbf00; /* Màu vàng sáng hơn khi hover */
    box-shadow: 0 6px #666; /* Tạo bóng đậm hơn */
    transform: translateY(-2px); /* Nhấc nút lên 2 pixels */
  }

  .button:active, .upload-button:active, .upload-submit:active { /* Style khi nhấn giữ nút */
    background-color: #e0ac00; /* Màu vàng sẫm hơn khi nhấn */
    box-shadow: 0 2px #666; /* Tạo bóng nhẹ hơn */
    transform: translateY(0px); /* Trả nút về vị trí ban đầu khi nhấn */
  }

  .image-container img {
    max-width: 100%; /* Chiều rộng tối đa của ảnh */
    max-height: 80vh; /* Chiều cao tối đa của ảnh theo viewport height */
    object-fit: contain; /* Đảm bảo không làm méo ảnh */
  }

  .d-none {
    display: none; /* Ẩn phần tử */
  }

  .d-flex {
    display: flex; /* Áp dụng flexbox */
  }

  .align-items-center {
    align-items: center; /* Căn giữa các item theo chiều dọc */
  }

  .align-items-start {
    align-items: flex-start; /* Căn đỉnh các item theo chiều dọc */
  }

  .mb-3 {
    margin-bottom: 1rem; /* Khoảng cách dưới 16px */
  }

  .text-danger {
    color: #dc3545; /* Màu chữ cảnh báo */
  }

  #noImageChosen {
    margin-top: 10px; /* Khoảng cách trên */
  }

  /* Phần này để chỉnh cho preview của cropper */
  .cropper-container {
    margin-top: 20px; /* Khoảng cách phần crop từ trên xuống */
    max-width: 650px; /* Chiều rộng tối đa của cropper */
    height: auto; /* Chiều cao tự động theo propor */
    margin-left: auto; /* Tự động căn giữa ngang */
    margin-right: auto; /* Tự động căn giữa ngang */
  }

  .img-preview {
    width: 100px; /* Chiều rộng của preview */
    height: 100px; /* Chiều cao của preview */
    overflow: hidden; /* Không hiển thị phần ảnh thừa */
    margin-top: 10px; /* Khoảng cách trên của preview */
    border: 1px solid #dee2e6; /* Viền xung quanh preview */
    background-size: cover; /* ảnh preview cover toàn bộ khu vực */
  }
</style>
   <!-- Scripts của jQuery sử dụng CDN để sử dụng thư viện nếu cần -->
  <script src="https://code.jquery.com/jquery-3.7.1.js" 
    integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" 
    crossorigin="anonymous"></script>
    
  <!-- Scripts của Bootstrap Bundle đính kèm Popper để sử dụng các chức năng như modal -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" 
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" 
    crossorigin="anonymous"></script>
  
  <!-- Scripts của Cropper.js đính kèm để tạo giao diện crop ảnh -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
</head>
<body>
  <div class="image-container mb-3">
    <img id="image" src="1.jpg" alt="Original Image">
  </div>
  <input type="file" id="imageInput" hidden>
  
  <label for="imageInput" class="button upload-button">CHỌN ẢNH</label>
  
  <div id="noImageChosen" class="text-danger d-none">Chưa chọn ảnh</div>
  
  <!-- Crop ảnh -->
  <div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="cropModalLabel">Điều chỉnh kích thước ảnh</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="crop-container" style="height: 500px;">
            <img id="cropper-image" class="h-100 w-100" style="max-width: 100%;" src="" alt="Ảnh cần crop">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tắt</button>
          <button type="button" class="btn btn-primary" id="cropModalSubmitButton">Xác nhận</button>
        </div>
      </div>
    </div>
  </div>
   <img id="croppedImage" src="#" alt="Cropped Image" hidden/>
  
  <button id="uploadButton" class="button upload-submit" hidden>UPLOAD</button>
  
<script>

  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    function dataURLtoBlob(dataURL)
    {
      const byteString = atob(dataURL.split(',')[1]);
      const ab = new ArrayBuffer(byteString.length);
      const ia = new Uint8Array(ab);

      for (let i = 0; i < byteString.length; i++)
      {
        ia[i] = byteString.charCodeAt(i);
      }

      return new Blob([ab], { type: 'image/png' }); // Đặt kiểu MIME tương ứng với loại ảnh bạn đang sử dụng
    }
  </script>
  <script>
    const API_NAME = "12345";
    const API_KEY = "w99E996F6Df1Dx3Tb9brixzx";
    let croppedDataURL = "";

    const fileInput = $('#imageUpload')[0];
    const uploadButton = $('.upload-submit');
    const backgroundImage = $('#background')[0];
    const isImageChosen = $('#noImageChosen');
    const screenWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
    const screenHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;

    $(document).ready(function ()
    {
      $('.upload-submit').on('click', function ()
      {
        handleUpload();
      });

      $('#imageUpload').on('change', function ()
      {
        $('#cropModal').modal('show');
        $('#cropModal').on('shown.bs.modal', function ()
        {
          const file = fileInput.files[0];
          const reader = new FileReader();

          reader.onload = function (e)
          {
            const cropperImage = $('#cropper-image');
            cropperImage.attr('src', e.target.result);

            const cropper = new Cropper(cropperImage[0], {
              aspectRatio: NaN,
              autoCropArea: 1,
              viewMode: 1
            });

            function handleCropSubmit()
            {
              const croppedCanvas = cropper.getCroppedCanvas();
              croppedDataURL = croppedCanvas.toDataURL(file.type);
              $('#cropModal').modal('hide');
            }

            $('#cropModalSubmitButton').on('click', handleCropSubmit);

            $('#cropModal').on('hidden.bs.modal', function ()
            {
              fileInput.value = "";
              cropper.destroy();
            });
          };

          reader.readAsDataURL(file);
        });

      });
    });

    async function handleUpload()
    {
      uploadButton.prop('disabled', true);
      uploadButton.text('Đang xử lý...');

      if (croppedDataURL === "")
      {
        uploadButton.prop('disabled', false);
        uploadButton.text('UPLOAD');
        isImageChosen.removeClass('d-none');
        return;
      }
     
      console.log(croppedDataURL);

      var byteString = atob(croppedDataURL.split(',')[1]);
      var ab = new ArrayBuffer(byteString.length);
      var ia = new Uint8Array(ab);
      for (var i = 0; i < byteString.length; i++)
      {
        ia[i] = byteString.charCodeAt(i);
      }

      // Tạo đối tượng Blob từ ArrayBuffer
      var blob = new Blob([ab], { type: 'image/png' });

      // Tạo đối tượng File từ Blob
      var file = new File([blob], 'filename.png', { type: 'image/png' });

      isImageChosen.addClass('d-none');
      const formData = new FormData();
      formData.append('size', 'auto');
      formData.append('image_file', file);

      try
      {
        const response = await axios.post('https://api.remove.bg/v1.0/removebg', formData, {
          headers: {
            'X-Api-Key': API_KEY,
          },
          responseType: 'blob',
        });

        const processedImageBlob = await response.data;
        const processedImageURL = URL.createObjectURL(processedImageBlob);
        const processedImage = new Image();

        processedImage.onload = function ()
        {
          var processedImageWidth = 768;
          var processedImageHeight = 1024;
          var processedImageX = 1000;
          var processedImageY = 20;

          const canvas = document.createElement('canvas');
          canvas.width = backgroundImage.naturalWidth;
          canvas.height = backgroundImage.naturalHeight;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(backgroundImage, 0, 0);
          ctx.drawImage(processedImage, processedImageX, processedImageY, processedImageWidth, processedImageHeight);

          backgroundImage.src = canvas.toDataURL('image/jpeg');

          URL.revokeObjectURL(processedImageURL);

          uploadButton.prop('disabled', false);
          uploadButton.text('UPLOAD');
        };

        processedImage.src = processedImageURL;

        uploadButton.prop('disabled', false);
        uploadButton.text('UPLOAD');
      } catch (error)
      {
        console.error(error);

        uploadButton.prop('disabled', false);
        uploadButton.text('UPLOAD');
      }
    }
  </script>
</body>

</html>
